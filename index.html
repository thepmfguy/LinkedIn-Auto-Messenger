<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkedIn Applicant Messenger</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.2/dist/quill.snow.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        .ql-editor {
            @apply min-h-[200px] text-gray-900 dark:text-gray-100;
        }
        .ql-toolbar {
            @apply bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700 rounded-t-lg;
        }
        .ql-container {
            @apply bg-white dark:bg-gray-900 border-gray-200 dark:border-gray-700 rounded-b-lg;
        }
        .dark .ql-snow {
            @apply border-gray-700;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Hero Section -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
        <div class="text-center">
            <h1 class="text-4xl sm:text-5xl font-bold text-gray-900 dark:text-white mb-4">
                LinkedIn Applicant Messenger
            </h1>
            <p class="text-xl text-gray-600 dark:text-gray-300">
                Automate your applicant messaging with personalized templates
            </p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Message Template Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-8">
            <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-4">Message Template</h2>
            <div class="mb-4">
                <div id="editor"></div>
            </div>
            <p class="text-sm text-gray-500 dark:text-gray-400">Use {name} to personalize messages with applicant names</p>
        </div>

        <!-- Options Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Applicant Limit -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                <label for="applicantLimit" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Number of Applicants to Process
                </label>
                <input type="number" id="applicantLimit" min="1" value="10"
                    class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>

            <!-- Approval Toggle -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Require Approval Before Sending
                </label>
                <div class="flex items-center">
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="approvalToggle" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                    </label>
                    <span id="approvalStatus" class="ml-3 text-sm font-medium text-gray-700 dark:text-gray-300">Enabled</span>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-4 mb-8">
            <button id="generateScript"
                class="flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors duration-200">
                Generate Script
            </button>
            <button id="copyScript"
                class="flex-1 px-6 py-3 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-lg transition-colors duration-200">
                Copy Script
            </button>
        </div>

        <!-- Generated Script Section -->
        <div id="scriptCard" class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-4">Your Custom Script</h2>
            <div class="relative">
                <div class="flex justify-between items-center bg-gray-900 px-4 py-3 rounded-t-lg">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 rounded-full bg-red-500"></div>
                        <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                        <div class="w-3 h-3 rounded-full bg-green-500"></div>
                    </div>
                    <button id="copyCodeBtn" class="px-3 py-1 text-sm bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg transition-colors duration-200 flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path>
                        </svg>
                        <span>Copy</span>
                    </button>
                </div>
                <pre id="scriptContent" class="bg-gray-900 text-gray-100 p-4 rounded-b-lg overflow-x-auto text-sm font-mono"></pre>
            </div>
        </div>

        <!-- How It Works Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-8">
            <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-6">How It Works</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="text-center">
                    <div class="w-12 h-12 mx-auto mb-4 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                        <svg class="w-6 h-6 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Customize Template</h3>
                    <p class="text-gray-600 dark:text-gray-400">Create your message template with rich text formatting</p>
                </div>
                <div class="text-center">
                    <div class="w-12 h-12 mx-auto mb-4 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                        <svg class="w-6 h-6 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Generate Script</h3>
                    <p class="text-gray-600 dark:text-gray-400">Get your personalized automation script</p>
                </div>
                <div class="text-center">
                    <div class="w-12 h-12 mx-auto mb-4 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                        <svg class="w-6 h-6 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Run Automation</h3>
                    <p class="text-gray-600 dark:text-gray-400">Paste the script in LinkedIn's console</p>
                </div>
            </div>
        </div>

        <!-- Detailed Instructions -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
            <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-6">Detailed Instructions</h2>
            <div class="space-y-6">
                <div class="flex items-start space-x-4">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-600 dark:text-gray-400">
                        1
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Visit Your Job Post</h3>
                        <p class="text-gray-600 dark:text-gray-400">Go to your LinkedIn job post and navigate to the view where all candidates are shown.</p>
                    </div>
                </div>
                <div class="flex items-start space-x-4">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-600 dark:text-gray-400">
                        2
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Open Developer Console</h3>
                        <p class="text-gray-600 dark:text-gray-400">Right-click anywhere on the page and select "Inspect" or press F12. Then click on the "Console" tab.</p>
                    </div>
                </div>
                <div class="flex items-start space-x-4">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-600 dark:text-gray-400">
                        3
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Enable Pasting</h3>
                        <p class="text-gray-600 dark:text-gray-400">If this is your first time, type "allow pasting" in the console when prompted.</p>
                    </div>
                </div>
                <div class="flex items-start space-x-4">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-600 dark:text-gray-400">
                        4
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Run the Script</h3>
                        <p class="text-gray-600 dark:text-gray-400">Paste the generated script and press Enter to start the automation. The tool will automatically start sending messages to candidates.</p>
                    </div>
                </div>
                <div class="flex items-start space-x-4">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-600 dark:text-gray-400">
                        5
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Multiple Pages</h3>
                        <p class="text-gray-600 dark:text-gray-400">Remember to run the script again when you navigate to the next page of applicants. Make sure to set the limit correctly to match the number of applicants on each page.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Theme Toggle -->
    <button id="themeToggle" class="fixed bottom-4 right-4 p-3 rounded-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm transition-transform duration-200 hover:scale-105">
        <svg class="w-6 h-6 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path id="themeIcon" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
        </svg>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.2/dist/quill.min.js"></script>
    <script>
        // Initialize Quill editor
        const quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'color': [] }, { 'background': [] }],
                    ['clean']
                ]
            },
            placeholder: 'Write your message template here...'
        });

        // Set default message
        quill.setContents([
            { insert: 'Hi {name},\n\n' },
            { insert: 'Thank you for applying to our position. We\'re currently reviewing applications and will get back to you soon.\n\n' },
            { insert: 'Best regards,\nYour Name' }
        ]);

        // Theme toggle functionality
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        
        themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            themeIcon.setAttribute('d', isDark 
                ? 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z'
                : 'M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z'
            );
        });

        // Approval toggle functionality
        const approvalToggle = document.getElementById('approvalToggle');
        const approvalStatus = document.getElementById('approvalStatus');
        
        approvalToggle.addEventListener('change', function() {
            approvalStatus.textContent = this.checked ? 'Enabled' : 'Disabled';
        });

        // Generate and copy script functionality
        document.getElementById('generateScript').addEventListener('click', function() {
            // Get the raw content from Quill editor
            const message = quill.getContents();
            const applicantLimit = document.getElementById('applicantLimit').value;
            const requireApproval = document.getElementById('approvalToggle').checked;
            
            // Convert Quill delta to formatted text and escape special characters
            let formattedMessage = '';
            message.ops.forEach(op => {
                if (op.insert) {
                    // Escape backticks and preserve line breaks
                    formattedMessage += op.insert
                        .replace(/`/g, '\\`')
                        .replace(/\n/g, '\\n')
                        .replace(/\$/g, '\\$');
                }
            });
            
            const script = `// LinkedIn Applicant Messenger Script
const config = {
    messageTemplate: \`${formattedMessage}\`,
    delayBetweenMessages: 3000,
    applicantLimit: ${applicantLimit},
    requireApproval: ${requireApproval}
};

const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

const waitForElement = async (selector, timeout = 10000) => {
    const startTime = Date.now();
    while (Date.now() - startTime < timeout) {
        const element = document.querySelector(selector);
        if (element) return element;
        await sleep(500);
    }
    return null;
};

const forceCloseMessageWindow = async () => {
    try {
        // Only target visible active conversations
        const conversations = document.querySelectorAll('.msg-overlay-conversation-bubble--is-active:not([style*="display: none"])');
        conversations.forEach(conv => {
            conv.style.display = 'none';
            conv.classList.remove('msg-overlay-conversation-bubble--is-active');
        });
        
        // Only remove visible overlays
        const overlays = document.querySelectorAll('.artdeco-modal-overlay:not([style*="display: none"])');
        overlays.forEach(overlay => {
            overlay.remove();
        });
        
        return true;
    } catch (error) {
        console.error('Error in force close:', error);
        return false;
    }
};

const isWindowVisible = (element) => {
    if (!element) return false;
    const style = window.getComputedStyle(element);
    return style.display !== 'none' && style.visibility !== 'hidden' && style.opacity !== '0';
};

const closeAllMessageWindows = async (excludeActive = false) => {
    let attempts = 0;
    let maxAttempts = 3;
    
    while (attempts < maxAttempts) {
        // Get all visible message windows
        const visibleWindows = Array.from(document.querySelectorAll('.msg-overlay-conversation-bubble'))
            .filter(isWindowVisible);
            
        // If excludeActive is true, don't close the window with an active message form
        const windowsToClose = excludeActive ? 
            visibleWindows.filter(window => !window.querySelector('.msg-form__contenteditable[contenteditable="true"]')) :
            visibleWindows;
            
        const closeButtons = windowsToClose.map(window => 
            window.querySelector('button.msg-overlay-bubble-header__control.artdeco-button--circle, button.msg-overlay-bubble-header__button')
        ).filter(button => button && isWindowVisible(button));
        
        const visibleModalCloseButtons = Array.from(document.querySelectorAll('button.artdeco-modal__dismiss'))
            .filter(isWindowVisible);
            
        const allCloseButtons = [...closeButtons, ...visibleModalCloseButtons];
        
        if (allCloseButtons.length === 0) {
            console.log('No closeable message windows found');
            break;
        }
        
        console.log(\`Attempt \${attempts + 1}: Found \${allCloseButtons.length} closeable message windows\`);
        
        for (const button of allCloseButtons) {
            try {
                button.click();
                await sleep(1000);
                
                // Only handle visible discard dialogs
                const discardButton = Array.from(document.querySelectorAll('button[data-control-name="discard_conversation"]'))
                    .find(isWindowVisible);
                    
                if (discardButton) {
                    console.log('Found visible discard dialog, clicking discard...');
                    discardButton.click();
                    await sleep(1000);
                }
            } catch (error) {
                console.error('Error clicking close button:', error);
            }
        }
        
        attempts++;
        await sleep(1000);
        
        // Check if any windows that should be closed remain
        const remainingCloseable = Array.from(document.querySelectorAll('.msg-overlay-conversation-bubble--is-active, .msg-overlay-conversation-bubble'))
            .filter(window => {
                if (!isWindowVisible(window)) return false;
                if (excludeActive && window.querySelector('.msg-form__contenteditable[contenteditable="true"]')) return false;
                return true;
            });
            
        if (remainingCloseable.length === 0) {
            console.log('All closeable message windows handled successfully');
            return true;
        }
    }
    
    // If normal close didn't work and we're not excluding active windows, try force close
    if (!excludeActive) {
        console.log('Attempting force close of remaining windows...');
        const forceClosed = await forceCloseMessageWindow();
    }
    
    return true;
};

const forceSetMessageContent = async (messageBox, text) => {
    try {
        // Force focus and clear
        messageBox.focus();
        messageBox.click();
        await sleep(500);
        
        // Force clear content using multiple methods
        messageBox.innerHTML = '';
        messageBox.textContent = '';
        messageBox.innerText = '';
        
        // Convert escaped newlines back to actual newlines
        const formattedText = text.replace(/\\n/g, '\n');
        
        // Force set content using multiple methods
        messageBox.innerHTML = formattedText;
        messageBox.textContent = formattedText;
        messageBox.innerText = formattedText;
        
        // Force trigger events
        const events = ['input', 'change', 'keydown', 'keyup', 'paste', 'compositionend'];
        events.forEach(eventType => {
            messageBox.dispatchEvent(new Event(eventType, { bubbles: true }));
        });
        
        // Force focus again
        messageBox.focus();
        messageBox.click();
        
        await sleep(1000);
        return true;
    } catch (error) {
        console.error('Error in forceSetMessageContent:', error);
        return false;
    }
};

const forceSendMessage = async (sendButton) => {
    try {
        // Force click using multiple methods
        sendButton.click();
        sendButton.dispatchEvent(new MouseEvent('click', {
            bubbles: true,
            cancelable: true,
            view: window
        }));
        
        // Try form submit
        const form = document.querySelector('form.msg-form');
        if (form) {
            form.dispatchEvent(new SubmitEvent('submit', {
                bubbles: true,
                cancelable: true
            }));
        }
        
        // Try direct form submission
        if (form) {
            form.submit();
        }
        
        // Try clicking any visible send buttons
        const allSendButtons = document.querySelectorAll('button.msg-form__send-button');
        allSendButtons.forEach(button => {
            if (isWindowVisible(button)) {
                button.click();
                button.dispatchEvent(new MouseEvent('click', {
                    bubbles: true,
                    cancelable: true,
                    view: window
                }));
            }
        });
        
        await sleep(2000);
        return true;
    } catch (error) {
        console.error('Error in forceSendMessage:', error);
        return false;
    }
};

const processApplicant = async (applicant) => {
    try {
        // Get applicant name
        const nameElement = applicant.querySelector('.artdeco-entity-lockup__title');
        if (!nameElement) {
            console.log('Could not find name element');
            return false;
        }

        const name = nameElement.textContent.trim();
        console.log('\nProcessing applicant:', name);

        // Force close all message windows
        await closeAllMessageWindows();
        await sleep(2000);

        // Force click applicant
        const applicantLink = applicant.querySelector('a');
        if (applicantLink) {
            applicantLink.click();
            await sleep(3000);
        }

        // Force click message button
        const messageButton = document.querySelector('button[data-view-name="hiring-applicant-contact-message"]');
        if (!messageButton) {
            console.log('Message button not found');
            return false;
        }

        messageButton.click();
        await sleep(3000);

        // Find message input and send button
        const messageInput = document.querySelector('div.msg-form__contenteditable[contenteditable="true"][role="textbox"]');
        const sendButton = document.querySelector('button.msg-form__send-button.artdeco-button--1[type="submit"]');
        
        if (!messageInput || !sendButton) {
            console.log('Message dialog elements not found');
            await closeAllMessageWindows();
            return false;
        }

        // Force set message content with retries
        console.log('Force setting message content...');
        const personalizedMessage = config.messageTemplate.replace(/{name}/g, name);
        let messageSet = false;
        for (let i = 0; i < 3; i++) {
            messageSet = await forceSetMessageContent(messageInput, personalizedMessage);
            if (messageSet) break;
            await sleep(1000);
        }

        if (!messageSet) {
            console.log('Failed to set message content after multiple attempts');
            await closeAllMessageWindows();
            return false;
        }

        // Only ask for confirmation if requireApproval is true
        if (config.requireApproval) {
            const shouldSend = confirm(\`Ready to send message to: \${name}\\n\\nClick OK to send, or Cancel to skip.\`);
            if (!shouldSend) {
                console.log('User skipped sending to:', name);
                await closeAllMessageWindows();
                return false;
            }
        }

        // Force send message with retries
        console.log('Force sending message...');
        let messageSent = false;
        for (let i = 0; i < 3; i++) {
            await forceSendMessage(sendButton);
            await sleep(2000);
            
            // Check if message was sent
            messageSent = !document.querySelector('div.msg-form__contenteditable[contenteditable="true"][role="textbox"]');
            if (messageSent) break;
            
            console.log(\`Retry \${i + 1} of sending message...\`);
        }

        if (messageSent) {
            console.log('Message sent successfully to:', name);
            await sleep(1000);
            await closeAllMessageWindows();
            return true;
        } else {
            console.log('Failed to send message to:', name);
            await closeAllMessageWindows();
            return false;
        }
    } catch (error) {
        console.error('Error processing applicant:', error);
        await closeAllMessageWindows();
        return false;
    }
};

const processAllApplicants = async () => {
    try {
        // Close any existing message windows before starting
        console.log('Closing all open message windows before starting...');
        await closeAllMessageWindows();
        await sleep(2000);

        // Get all applicants
        const applicants = document.querySelectorAll('li.hiring-applicants__list-item');
        const totalApplicants = applicants.length;
        
        if (!totalApplicants) {
            throw new Error('No applicants found. Make sure you are on the correct LinkedIn page.');
        }

        // Determine how many to process
        const limit = config.applicantLimit || totalApplicants;
        const applicantsToProcess = Math.min(limit, totalApplicants);
        
        console.log(\`Found \${totalApplicants} applicants. Will process \${applicantsToProcess}.\`);
        console.log(\`Approval required: \${config.requireApproval ? 'Yes' : 'No'}\`);

        let processed = 0;
        for (let i = 0; i < applicantsToProcess; i++) {
            console.log(\`\\nProcessing applicant \${i + 1} of \${applicantsToProcess}\`);
            
            // Ensure all message windows are closed before each applicant
            await closeAllMessageWindows();
            await sleep(2000);
            
            const success = await processApplicant(applicants[i]);
            if (success) processed++;
            
            // Wait between applicants
            await sleep(config.delayBetweenMessages);
        }

        // Final cleanup
        await closeAllMessageWindows();
        
        console.log(\`\\nFinished processing applicants\`);
        console.log(\`Successfully processed \${processed} out of \${applicantsToProcess} applicants\`);
        
        alert(\`Successfully processed \${processed} out of \${applicantsToProcess} applicants\`);
    } catch (error) {
        alert(\`Error: \${error.message}\`);
        console.error('Script error:', error);
    }
};

// Start the process
console.log('Starting LinkedIn Applicant Messenger...');
console.log('Approval required:', ${requireApproval} ? 'Yes' : 'No');
processAllApplicants().then(() => {
    console.log('Script completed');
}).catch(error => {
    console.error('Script failed:', error);
});`;

            const scriptCard = document.getElementById('scriptCard');
            const scriptContent = document.getElementById('scriptContent');
            
            scriptContent.textContent = script;
            scriptCard.classList.remove('hidden');
            scriptCard.scrollIntoView({ behavior: 'smooth' });
            
            // Apply syntax highlighting
            hljs.highlightElement(scriptContent);
        });

        document.getElementById('copyCodeBtn').addEventListener('click', function() {
            const script = document.getElementById('scriptContent').textContent;
            if (script) {
                navigator.clipboard.writeText(script).then(() => {
                    // Show success animation
                    const copyBtn = document.getElementById('copyCodeBtn');
                    copyBtn.innerHTML = `
                        <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="text-green-500">Copied!</span>
                    `;
                    setTimeout(() => {
                        copyBtn.innerHTML = `
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path>
                            </svg>
                            <span>Copy</span>
                        `;
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy script:', err);
                    alert('Failed to copy script. Please try again.');
                });
            }
        });
    </script>
</body>
</html> 
